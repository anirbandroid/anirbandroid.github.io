<!DOCTYPE html>
<html>
<head>
    <title>Select Menu</title>
	<meta charset="utf-8" http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link rel="apple-touch-icon" sizes="76x76" href="assets/images/favicon2.ico" />
    <link rel="icon" type="image/ico" href="assets/images/favicon2.ico" />
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="assets/css/fontawesome/css/all.min.css" rel="stylesheet" />
    <link href="assets/css/menu.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <img class="imgLogo" alt="" />
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <fieldset class="scheduler-border">
                    <legend class="textLegend">
                        Mocktails & Beverages&nbsp;
                        <i class='fas fa-cocktail fa-lg' style='color: #75c8f5'></i>
                    </legend>
                    <div class="row" id="divMocktailsBV"></div>
                </fieldset>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <fieldset class="scheduler-border">
                    <legend class="textLegend">
                        Appetizer Veg&nbsp;
                        <i class='fas fa-carrot fa-lg' style='color: #3DC53B;'></i>
                    </legend>
                    <div class="row" id="divVegStarter"></div>
                </fieldset>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <fieldset class="scheduler-border">
                    <legend class="textLegend">
                        Appetizer Non-Veg
                        &nbsp;<i class='fa fa-fish fa-lg' style='color: #f65757'></i>
                        &nbsp;<i class='fa fa-bone fa-lg' style='color: #e90f0f'></i>
                    </legend>
                    <div class="row" id="divNonVegStarter"></div>
                </fieldset>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <fieldset class="scheduler-border">
                    <legend class="textLegend">
                        Desi Chaat&nbsp;
                        <i class='fa fa-hamburger fa-lg' style='color: #fbaa3b'></i>
                    </legend>
                    <div class="row" id="divChaat"></div>                    
                </fieldset>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <fieldset class="scheduler-border">
                    <legend class="textLegend">
                        Desert&nbsp;
                        <i class='fa fa-ice-cream fa-lg' style='color: #dc87be'></i>
                    </legend>
                    <div class="row" id="divDesert"></div>
                </fieldset>
            </div>
        <input type="button" class="btn btnOrder shaky-btn" id="btnOrder" value="ORDER NOW" />
    </div>
    <script src="assets/script/jquery.min.js"></script>
    <script src="assets/script/bootstrap.min.js"></script>
    <script src="assets/css/sweetalert/sweetalert.min.js"></script>
    <script src="assets/css/fontawesome/js/all.min.js"></script>
    <script src="data/data.js"></script>
    <script type="application/javascript" src="http://ipinfo.io/?format=jsonp&callback=getIP"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js'
        import { getFirestore, doc, getDoc, setDoc, Timestamp, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js'

        const firebaseConfig = {
            apiKey: "AIzaSyBkIVRoJTqEtwKKsOB7dMGuKauJ_den2ew",
            authDomain: "test-5acde.firebaseapp.com",
            projectId: "test-5acde",
            storageBucket: "test-5acde.firebasestorage.app",
            messagingSenderId: "801361787817",
            appId: "1:801361787817:web:aa053f70023512f96da2b8",
            measurementId: "G-G73MHFD18Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore();

        $('#btnOrder').click(function(){
            console.log("------1---------")
            var tableId = $.urlParam('tableId');
            if(itemArr.length > 0){
                if(tableId != null && tableId != undefined && tableId != ""){
                    swal({
                        title: "Are you sure?",
                        text: "Click yes to allow us prapare your food!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Yes",
                        cancelButtonText: "No",
                        closeOnConfirm: false,
                        closeOnCancel: true
                        },
                        function(isConfirm){
                            if (isConfirm) {
                                var orderId = Generator() + "_" + tableId;
                                console.log(counterArr);
                                const createParentOrder = setDoc(doc(db, "orders", orderId), {
                                    items: itemArr + "",
                                    status: "Ordered",
                                    table_id: tableId,
                                    timestamp: Timestamp.fromDate(new Date())
                                });
                                for(var i=0; i<counterArr.length; i++){
                                    var elem = counterArr[i];
                                    var childOrderId = orderId + "_" + i.toString();
                                    const createItemOrders = setDoc(doc(db, "order_items", childOrderId), {
                                        counter: elem[1],
                                        createdAt: Timestamp.fromDate(new Date()),
                                        item: elem[0],
                                        orderId: orderId,
                                        status: "Ordered",
                                        tableId: tableId
                                    });
                                }
                                swal("You have great taste buds!", "Give us a few moments to serve you!!", "success");
                                itemArr = null;
                                counterArr = null;
                                $('input:checkbox').removeAttr('checked');
                            }
                    });
                }else{
                    swal("Try Again Later!", "Something Went Wrong!!", "error");                
                }
            }else{                
                swal("No Selection!", "Atleast selct one item to serve you!!", "info");                
            }
        });
    </script>
    <script>
        function createDivs(dataset, divID) {
            $(jQuery.parseJSON(JSON.stringify(dataset))).each(function () {
                var lDiv = "<div class='row'><div class='col-md-1'></div><div class='col-md-11'>";
                lDiv += "<div class='form-check'>";
                lDiv += "<input class='form-check-input' style='cursor:pointer' name='chkMenu' type='checkbox' value='" + this.counter + "'id='" + this.id + "'>&nbsp;";
                lDiv += "<label class='form-check-label labelHeader' style='cursor:pointer' for='" + this.id + "'>" + this.name + "</label>";
                lDiv += "&nbsp;<img alt='' src='assets/images/" + this.icon + "' title='" + this.title + "'/></div></div></div>";
                $("#" + divID).append(lDiv);
            });
        }

        $(document).ready(function () {
            createDivs(mocktailsbv, "divMocktailsBV");
            createDivs(chat, "divChaat");
            createDivs(starterVeg, "divVegStarter");
            createDivs(starterNonVeg, "divNonVegStarter");
            createDivs(desert, "divDesert");
        });
        
        let itemArr = [];
        let counterArr = [];
        $(function () {
            $(".form-check input").change(function () {
                const lMax = 3;
                let itemIds = [];
                let itemTexts = [];
                let itemCounter = [];
                $("input:checkbox[name=chkMenu]:checked").each(function () {
                    if (itemIds.length < lMax) {
                        var counterVal = $(this).val();
                        var itemVal = $(this).next("label").text();
                        itemIds.push(counterVal);
                        itemTexts.push(itemVal);
                        itemArr = itemTexts;
                        itemCounter.push([itemVal, counterVal]);
                        counterArr = itemCounter;
                        $('#btnOrder').focus();
                    } else {
                        $(this).prop("checked", false);
                        swal("Great Selection!", lMax + " items can be ordered together to serve you fast!!", "info");
                    }
                });
            });
        });

        $.urlParam = function(name){
            var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
            if (results==null) {
            return null;
            }
            return decodeURI(results[1]) || 0;
        }

        function Generator() {
            return Math.floor(Math.random() * 26) + Date.now();
        };

        // function getIP(json) {
        //     console.log("My public IP address is: ", json.ip);
        // }
    </script>
</body>
</html>
